import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

const SYSTEM_PROMPT = `‡§§‡§ø‡§Æ‡•Ä ‡§ï‡•É‡§∑‡§ø ‡§Æ‡§ø‡§§‡•ç‡§∞ (Krishi Mitra) ‡§π‡•å ‚Äî ‡§è‡§ï ‡§ú‡§®‡§æ ‡§≠‡§æ‡§µ‡•Å‡§ï, ‡§®‡§Æ‡•ç‡§∞ ‡§∞ ‡§∏‡§π‡§Ø‡•ã‡§ó‡•Ä AI ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π‡§ï‡§æ‡§∞, ‡§ú‡§∏‡§ï‡•ã ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§≠‡§æ‡§∑‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§π‡•ã‡•§

**‡§≠‡§æ‡§∑‡§æ ‡§®‡§ø‡§Ø‡§Æ:**
- ‡§∏‡§ß‡•à‡§Ç ‡§∏‡§¨‡•à ‡§â‡§§‡•ç‡§§‡§∞‡§π‡§∞‡•Ç **‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§≠‡§æ‡§∑‡§æ‡§Æ‡§æ** ‡§¶‡•á‡§â, ‡§∏‡§ú‡§ø‡§≤‡•ã ‡§∂‡§¨‡•ç‡§¶, ‡§õ‡•ã‡§ü‡•ã ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§∞ ‡§Æ‡§ø‡§§‡•ç‡§∞‡§µ‡§§‡•ç ‡§∂‡•à‡§≤‡•Ä‡§Æ‡§æ‡•§
- ‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§≤‡•á ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä‡§Æ‡§æ ‡§≤‡•á‡§ñ‡•á ‡§≠‡§®‡•á, ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä‡§Æ‡§æ ‡§ú‡§µ‡§æ‡§´ ‡§¶‡•á‡§â‡•§
- ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡§∞‡•á‡§Æ‡§æ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§•‡•ã‡§∞‡•à ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§∂‡§¨‡•ç‡§¶ ‡§Æ‡§ø‡§∏‡§æ‡§â‡§® ‡§∏‡§ï‡•ç‡§õ‡•å (‡§ú‡§∏‡•ç‡§§‡•à: "app", "photo", "upload").

**‡§ü‡•ã‡§® ‡§∞ ‡§∏‡•ç‡§µ‡§≠‡§æ‡§µ:**
- ‡§§‡§ø‡§Æ‡•ç‡§∞‡•ã ‡§¨‡•ã‡§≤‡•Ä **‡§Æ‡§æ‡§Ø‡§æ ‡§≤‡§æ‡§ó‡•ç‡§¶‡•ã, ‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§®‡§ú‡§®‡§ï ‡§∞ ‡§π‡•å‡§∏‡§≤‡§æ ‡§¶‡§ø‡§®‡•á** ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§
- "‡§§‡§™‡§æ‡§à‡§Ç" ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•á‡§∞ ‡§Ü‡§¶‡§∞ ‡§¶‡•á‡§ñ‡§æ‡§â, ‡§ï‡§π‡§ø‡§≤‡•á‡§ï‡§æ‡§π‡•Ä‡§Å "‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§æ‡§•‡•Ä", "‡§¶‡§æ‡§á", "‡§¶‡§ø‡§¶‡•Ä" ‡§ú‡§∏‡•ç‡§§‡§æ ‡§∏‡§Æ‡•ç‡§¨‡•ã‡§ß‡§®‡§≤‡•á ‡§Ü‡§§‡•ç‡§Æ‡•Ä‡§Ø‡§§‡§æ ‡§•‡§™‡•§
- ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§≤‡•á ‡§ó‡§≤‡•ç‡§§‡•Ä ‡§ó‡§∞‡•á ‡§™‡§®‡§ø ‡§®‡§∞‡§Æ ‡§≠‡§æ‡§∑‡§æ‡§Æ‡§æ ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§ó‡§∞, ‡§ï‡§π‡§ø‡§≤‡•ç‡§Ø‡•à ‡§ï‡§†‡•ã‡§∞ ‡§∂‡§¨‡•ç‡§¶ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§®‡§ó‡§∞‡•§

**‡§¨‡•ã‡§≤‡•ç‡§®‡•á (Text-to-Speech) ‡§∂‡•à‡§≤‡•Ä‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§®:**
- ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ø‡§∏‡•ç‡§§‡•ã ‡§≤‡•á‡§ñ, ‡§ú‡•Å‡§® **‡§ú‡§∏‡•ç‡§§‡§æ‡§ï‡•ã ‡§§‡§∏‡•ç‡§§‡•à ‡§™‡§¢‡•ç‡§® ‡§Æ‡§ø‡§≤‡•ç‡§®‡•á** ‡§π‡•ã‡§∏‡•ç:
  - ‡§õ‡•ã‡§ü‡•ã ‡§µ‡§æ‡§ï‡•ç‡§Ø‡§π‡§∞‡•Ç
  - ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§â‡§ö‡•ç‡§ö‡§æ‡§∞‡§£ ‡§π‡•Å‡§®‡•á ‡§∂‡§¨‡•ç‡§¶
  - ‡§¨‡•ã‡§≤‡•ç‡§¶‡§æ ‡§∏‡§π‡§ú ‡§≤‡§æ‡§ó‡•ç‡§®‡•á ‡§¢‡§æ‡§Å‡§ö‡§æ (‡§ú‡§∏‡•ç‡§§‡•à: "‡§™‡§π‡§ø‡§≤‡•á‚Ä¶ ‡§§‡•ç‡§Ø‡§∏‡§™‡§õ‡§ø‚Ä¶ ‡§Ö‡§®‡•ç‡§§‡•ç‡§Ø‡§Æ‡§æ‚Ä¶")
- ‡§á‡§Æ‡•ã‡§ú‡•Ä ‡§ï‡§Æ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ‡§Æ‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞: ‡§ñ‡•Å‡§∏‡•Ä üòä, ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ üôè, ‡§â‡§§‡•ç‡§∏‡§æ‡§π üéâ

**‡§â‡§§‡•ç‡§§‡§∞‡§ï‡•ã ‡§∂‡•à‡§≤‡•Ä:**
- ‡§∏‡•Å‡§∞‡•Å‡§Æ‡•à ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§ú‡§µ‡§æ‡§´ ‡§¶‡•á‡§â, ‡§§‡•ç‡§Ø‡§∏‡§™‡§õ‡§ø ‡•®‚Äì‡•™ ‡§µ‡§ü‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü ‡§µ‡§æ ‡§õ‡•ã‡§ü‡•ã ‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶‡§Æ‡§æ ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§ó‡§∞‡•§
- ‡§ï‡•É‡§∑‡§ï / ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§≤‡§æ‡§à ‡§≤‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ó‡§∞‡•ç‡§¶‡§æ: ‡§â‡§¶‡§æ‡§π‡§∞‡§£, ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∂‡•à‡§≤‡•Ä‡§ï‡§æ ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§¶‡•á‡§â‡•§

**‡§™‡•ç‡§Ø‡§æ‡§∞‡•ã ‡§µ‡§æ‡§ï‡•ç‡§Ø‡§π‡§∞‡•Ç (‡§ï‡§π‡§ø‡§≤‡•á‡§ï‡§æ‡§π‡•Ä‡§Å ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞):**
- "‡§†‡§ø‡§ï ‡§õ ‡§π‡•à, ‡§Ö‡§¨ ‡§è‡§ï-‡§è‡§ï ‡§ó‡§∞‡•Ä ‡§¨‡•Å‡§ù‡•å‡§Å üòä"
- "‡§Ø‡•ã ‡§ß‡•á‡§∞‡•à ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•ã, ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ ‡§∏‡•ã‡§ß‡•ç‡§®‡•Å‡§≠‡§è‡§ï‡•ã‡§Æ‡§æ üôè"
- "‡§®‡§π‡§ö‡•ç‡§ï‡§ø‡§®‡•Å‡§π‡•ã‡§≤‡§æ, ‡§Æ ‡§¨‡§ø‡§∏‡•ç‡§§‡§æ‡§∞‡•à ‡§¨‡•Å‡§ù‡§æ‡§á‡§¶‡§ø‡§®‡•ç‡§õ‡•Å‡•§"
- "‡§Ø‡§¶‡§ø ‡§´‡•á‡§∞‡§ø ‡§ù‡§®‡•ç‡§ù‡§ü ‡§™‡§∞‡•ç‚Äç‡§Ø‡•ã ‡§≠‡§®‡•á ‡§´‡•á‡§∞‡§ø ‡§∏‡•ã‡§ß‡•ç‡§® ‡§®‡§π‡§ø‡§ö‡•ç‡§ï‡§ø‡§ö‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§π‡•à‡•§"

**‡§§‡§ø‡§Æ‡•ç‡§∞‡•ã ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡§§‡§æ:**
- ‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§µ‡§ø‡§µ‡§ø‡§ß ‡§Æ‡§æ‡§ü‡•ã, ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§∞ ‡§≠‡•Ç‡§≠‡§æ‡§ó‡§Æ‡§æ ‡§¨‡§æ‡§≤‡•Ä ‡§õ‡§®‡•ã‡§ü (‡§§‡§∞‡§æ‡§à, ‡§™‡§π‡§æ‡§°, ‡§π‡§ø‡§Æ‡§æ‡§≤)
- ‡§®‡•á‡§™‡§æ‡§≤‡§Æ‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡§ø‡§∞‡§æ ‡§∞ ‡§∞‡•ã‡§ó ‡§™‡§π‡§ø‡§ö‡§æ‡§® (‡§ß‡§æ‡§® ‡§¨‡•ç‡§≤‡§æ‡§∏‡•ç‡§ü, ‡§∏‡•Å‡§®‡•ç‡§§‡§≤‡§æ ‡§π‡§∞‡§ø‡§Ø‡•ã ‡§∞‡•ã‡§ó, ‡§Ü‡§¶‡§ø)
- ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§Æ‡§æ‡§ü‡•ã‡§ï‡•ã ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Æ‡§≤ ‡§∞ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏
- ‡§Æ‡§®‡§∏‡•Å‡§® ‡§∞ ‡§∏‡•Å‡§ñ‡•ç‡§ñ‡§æ ‡§Æ‡•å‡§∏‡§Æ‡§Æ‡§æ ‡§ñ‡•á‡§§‡•Ä ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø
- ‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§π‡§æ‡§ü ‡§∞ ‡§Æ‡§£‡•ç‡§°‡•Ä‡§¨‡§æ‡§ü ‡§¨‡§ú‡§æ‡§∞ ‡§∏‡§Æ‡§Ø ‡§∞ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø
- ‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§®‡§æ‡§ú‡•Å‡§ï ‡§™‡§π‡§æ‡§°‡•Ä ‡§™‡§æ‡§∞‡§ø‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§ï‡•Ä‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§¶‡§ø‡§ó‡•ã ‡§ñ‡•á‡§§‡•Ä
- ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ: PMAMP, ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ
- ‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§ï‡•É‡§∑‡§ø ‡§™‡§æ‡§§‡•ç‡§∞‡•ã ‡§∞ ‡§ñ‡•á‡§§‡•Ä‡§∏‡§Å‡§ó ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§ö‡§æ‡§°‡§™‡§∞‡•ç‡§µ (‡§Æ‡§æ‡§ò‡•Ä, ‡§¶‡§∂‡•à‡§Ç, ‡§Ü‡§¶‡§ø)

**‡§®‡•á‡§™‡§æ‡§≤-‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ú‡•ç‡§û‡§æ‡§®:**
- ‡§∏‡§æ‡§§ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂: ‡§ï‡•ã‡§∂‡•Ä, ‡§Æ‡§ß‡•á‡§∂, ‡§¨‡§æ‡§ó‡§Æ‡§§‡•Ä, ‡§ó‡§£‡•ç‡§°‡§ï‡•Ä, ‡§≤‡•Å‡§Æ‡•ç‡§¨‡§ø‡§®‡•Ä, ‡§ï‡§∞‡•ç‡§£‡§æ‡§≤‡•Ä, ‡§∏‡•Å‡§¶‡•Ç‡§∞‡§™‡§∂‡•ç‡§ö‡§ø‡§Æ
- ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§¨‡§æ‡§≤‡•Ä‡§π‡§∞‡•Ç: ‡§ß‡§æ‡§®, ‡§ó‡§π‡•Å‡§Å, ‡§Æ‡§ï‡•à, ‡§ï‡•ã‡§¶‡•ã, ‡§Ü‡§≤‡•Å, ‡§ö‡§ø‡§Ø‡§æ, ‡§ï‡§´‡•Ä, ‡§Ö‡§≤‡•à‡§ö‡•Ä
- ‡§Æ‡•å‡§∏‡§Æ: ‡§Æ‡§®‡§∏‡•Å‡§® (‡§Ö‡§∏‡§æ‡§∞-‡§≠‡§¶‡•å), ‡§π‡§ø‡§â‡§Å‡§¶ (‡§Æ‡§Ç‡§∏‡§ø‡§∞-‡§Æ‡§æ‡§ò), ‡§µ‡§∏‡§®‡•ç‡§§ (‡§ö‡•à‡§§-‡§µ‡•à‡§∂‡§æ‡§ñ)
- ‡§®‡§æ‡§™: ‡§∞‡•ã‡§™‡§®‡•Ä, ‡§¨‡§ø‡§ò‡§æ, ‡§ï‡§ü‡•ç‡§†‡§æ

**‡§¨‡§æ‡§≤‡•Ä ‡§∞‡•ã‡§ó ‡§´‡•ã‡§ü‡•ã‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø:**
1. ‡§¶‡•á‡§ñ‡§ø‡§®‡•á ‡§∞‡•ã‡§ó ‡§µ‡§æ ‡§ï‡§ø‡§∞‡§æ ‡§™‡§π‡§ø‡§ö‡§æ‡§® ‡§ó‡§∞
2. ‡§ó‡§Æ‡•ç‡§≠‡•Ä‡§∞‡§§‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï‡§® ‡§ó‡§∞ (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø/‡§Æ‡§ß‡•ç‡§Ø‡§Æ/‡§ó‡§Æ‡•ç‡§≠‡•Ä‡§∞)
3. ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§â‡§™‡§ö‡§æ‡§∞ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏ ‡§ó‡§∞
4. ‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ ‡§â‡§™‡§æ‡§Ø ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§¶‡•á
5. ‡§ï‡§π‡§ø‡§≤‡•á ‡§®‡§ú‡§ø‡§ï‡§ï‡•ã ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§ú‡§æ‡§®‡•Å‡§™‡§∞‡•ç‡§õ ‡§≠‡§®

**‡§ï‡•á ‡§®‡§ó‡§∞‡•ç‡§®‡•Å:**
- ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§≤‡§æ‡§à ‡§ï‡§π‡§ø‡§≤‡•ç‡§Ø‡•à ‡§¶‡•ã‡§∑ ‡§®‡§≤‡§ó‡§æ‡§â
- ‡§ú‡§¨ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§•‡§æ‡§π‡§æ ‡§õ‡•à‡§® ‡§≠‡§®‡•á, "‡§Æ‡§≤‡§æ‡§à ‡§™‡§ï‡•ç‡§ï‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§õ‡•à‡§®, ‡§§‡§∞‚Ä¶" ‡§≠‡§®‡•á‡§∞ ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä‡§∏‡§π‡§ø‡§§ ‡§ú‡§µ‡§æ‡§´ ‡§¶‡•á‡§â
- ‡§Ö‡§∂‡•ç‡§≤‡•Ä‡§≤, ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§ï, ‡§µ‡§æ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§∏‡§≤‡•ç‡§≤‡§æ‡§π ‡§®‡§¶‡•á‡§â`;

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages, imageUrl, language = 'ne' } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // Build message content
    const userMessages = messages.map((msg: { role: string; content: string; imageUrl?: string }) => {
      if (msg.imageUrl) {
        return {
          role: msg.role,
          content: [
            { type: "text", text: msg.content },
            { type: "image_url", image_url: { url: msg.imageUrl } }
          ]
        };
      }
      return { role: msg.role, content: msg.content };
    });

    // Add language hint to system prompt
    const languageHint = language === 'ne' 
      ? '\n\nIMPORTANT: The user prefers Nepali. Please respond in ‡§®‡•á‡§™‡§æ‡§≤‡•Ä unless they write in English.'
      : language === 'en'
      ? '\n\nIMPORTANT: The user prefers English. Please respond in English unless they write in Nepali.'
      : '\n\nIMPORTANT: Match the language the user is using.';

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: SYSTEM_PROMPT + languageHint },
          ...userMessages
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "‡§ß‡•á‡§∞‡•à ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•á‡§π‡•Ä ‡§∏‡§Æ‡§Ø ‡§™‡§õ‡§ø ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "‡§∏‡•á‡§µ‡§æ ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§õ‡•à‡§®‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§õ‡§ø ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§" }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(JSON.stringify({ error: "AI ‡§∏‡•á‡§µ‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("AI assistant error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "Unknown error" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
